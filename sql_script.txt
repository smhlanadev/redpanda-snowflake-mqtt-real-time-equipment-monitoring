USE ROLE ACCOUNTADMIN;

-- Create a user
CREATE USER IF NOT EXISTS IDENTIFIER('MAINTENANCE_USER') PASSWORD='Maint1234567';

-- Create a role
CREATE OR REPLACE ROLE IDENTIFIER('REDPANDA_CONNECT');

-- Create a database and a warehouse
CREATE DATABASE IF NOT EXISTS IDENTIFIER('FACTORY_DB');
USE IDENTIFIER('FACTORY_DB');
CREATE OR REPLACE WAREHOUSE IDENTIFIER('FACTORY_WH') WITH WAREHOUSE_SIZE = 'SMALL';

-- Grant the role the privilege to create new warehouses
GRANT CREATE WAREHOUSE ON ACCOUNT TO ROLE IDENTIFIER('REDPANDA_CONNECT');
-- Grant the user the REDPANDA_CONNECT role
GRANT ROLE IDENTIFIER('REDPANDA_CONNECT') TO USER IDENTIFIER('MAINTENANCE_USER');
-- Transfer ownership of the database to the user
GRANT OWNERSHIP ON DATABASE IDENTIFIER('FACTORY_DB') TO ROLE IDENTIFIER('REDPANDA_CONNECT');
-- Grant the role REDPANDA_CONNECT usage permission to the FACTORY_WH warehouse
GRANT USAGE ON WAREHOUSE IDENTIFIER('FACTORY_WH') TO ROLE IDENTIFIER('REDPANDA_CONNECT');

-- Set the default role for MAINTENANCE_USER to REDPANDA_CONNECT
ALTER USER IDENTIFIER('MAINTENANCE_USER') SET DEFAULT_ROLE='REDPANDA_CONNECT';
-- Set the default warehouse for MAINTENANCE_USER to FACTORY_WH
ALTER USER IDENTIFIER('MAINTENANCE_USER') SET DEFAULT_WAREHOUSE='FACTORY_WH';

-- Get the account identifier
WITH HOSTLIST AS 
(SELECT * FROM TABLE(FLATTEN(INPUT => PARSE_JSON(SYSTEM$allowlist()))))
SELECT REPLACE(VALUE:host,'.snowflakecomputing.com','') AS ACCOUNT_IDENTIFIER
FROM HOSTLIST
WHERE VALUE:type = 'SNOWFLAKE_DEPLOYMENT_REGIONLESS';

-- Assign public key to the user
ALTER USER MAINTENANCE_USER SET RSA_PUBLIC_KEY="<pub_key>‚Äù;

-- Create DB schema
USE IDENTIFIER('FACTORY_DB');
CREATE OR REPLACE SCHEMA IDENTIFIER('FACTORY_SCHEMA');
